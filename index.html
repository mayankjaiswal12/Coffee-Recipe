<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>The Daily Brew</title>
    <style>
        :root {
            --bg: #F9F9F9;
            --surface: #FFFFFF;
            --text: #333;
            --border: #E0E0E0;
            --primary: #333;
            --accent-blue: #A2D2FF;
            --accent-red: #FFAAA5;
            --accent-yellow: #FFD3B6;
            --accent-green: #CaffBF;
            --accent-purple: #E0C3FC;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- LAYOUT --- */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            align-items: start;
        }
        
        /* Library Section (New) */
        .library-container {
            margin-top: 40px;
            border-top: 2px solid var(--border);
            padding-top: 20px;
        }

        @media (max-width: 768px) {
            .main-container { grid-template-columns: 1fr; } 
        }

        h1, h2 { display: flex; align-items: center; gap: 10px; margin: 0 0 20px 0; }
        h2 { font-size: 1.3rem; margin-bottom: 15px; }
        .logo-icon { font-size: 1.5rem; }

        /* --- CARDS --- */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .card-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        /* --- FORMS --- */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        label { display: block; font-size: 0.75rem; font-weight: 600; color: #666; margin-bottom: 5px; }
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.9rem; background: #FAFAFA; box-sizing: border-box;
        }
        
        /* --- BUTTONS --- */
        button { cursor: pointer; border: none; font-weight: bold; border-radius: 6px; }
        #add-step-btn { width: 100%; background: #333; color: white; padding: 12px; margin-top: 15px; }
        #save-recipe-btn { background: #FF4444; color: white; padding: 10px 20px; border-radius: 20px; float: right; }
        
        /* --- TIMELINE (Shared Style) --- */
        .step-list { display: flex; flex-direction: column; gap: 10px; }
        .timeline-item {
            display: flex; background: white; border: 1px solid var(--border);
            border-radius: 8px; overflow: hidden; position: relative;
        }
        .color-bar { width: 12px; flex-shrink: 0; }
        .timeline-content { padding: 12px 15px; flex-grow: 1; }
        .step-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .step-title { font-weight: 700; font-size: 0.95rem; }
        .step-type { font-size: 0.7rem; color: #888; text-transform: uppercase; font-style: italic; }
        .step-time { font-family: monospace; font-size: 1.1rem; font-weight: 600; color: #333; }
        .step-details { font-size: 0.85rem; color: #555; margin-top: 4px; }
        .delete-step { background: none; color: #ccc; font-size: 1.2rem; padding: 0 15px; }
        .delete-step:hover { color: red; }

        /* --- LIBRARY STYLES (New) --- */
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .saved-recipe-card {
            background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px;
            transition: transform 0.2s; position: relative;
        }
        .saved-recipe-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .saved-header h3 { margin: 0; font-size: 1.1rem; color: var(--primary); }
        .saved-meta { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .saved-tags { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; background: #eee; font-weight: 600; }
        
        .view-btn { width: 100%; background: #333; color: white; padding: 8px; margin-top: 10px; }
        .delete-recipe-btn { 
            position: absolute; top: 15px; right: 15px; background: none; 
            color: #ff4444; font-size: 1.2rem; padding: 0; 
        }

        /* Helpers */
        .bg-yellow { background-color: #FCDF87; }
        .bg-blue { background-color: #B2DFDB; }
        .bg-red { background-color: #FFCDD2; }
        .bg-purple { background-color: #E1BEE7; }
        .bg-gray { background-color: #EEEEEE; }
        .bg-brown { background-color: #D7CCC8; }
        .selected { transform: scale(1.1); border: 2px solid #333; }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-picker { display: flex; gap: 10px; margin-top: 5px; }

    </style>
</head>
<body>

    <header>
        <h1>
            <span class="logo-icon">☕</span> Recipe Builder 
            <button id="save-recipe-btn">Save Recipe</button>
        </h1>
    </header>

    <div class="main-container">
        
        <div class="left-col">
            <div class="card">
                <div class="card-header">Details</div>
                
                <div style="margin-bottom: 15px;">
                    <label>Bean Name / Origin</label>
                    <input type="text" id="beanName" placeholder="e.g. Ethiopia Yirgacheffe">
                </div>

                <div class="grid-2">
                    <div>
                        <label>Recipe Name</label>
                        <input type="text" id="recipeName" placeholder="e.g. Morning Brew">
                    </div>
                    <div>
                        <label>Method</label>
                        <input type="text" id="brewer" list="methodSuggestions" placeholder="Select or type..." required>
                        <datalist id="methodSuggestions">
                            <option value="V60"></option>
                            <option value="Aeropress"></option>
                            <option value="French Press"></option>
                            <option value="Espresso"></option>
                            <option value="Moka Pot"></option>
                            <option value="Chemex"></option>
                            <option value="Siphon"></option>
                            <option value="Cold Brew"></option>
                        </datalist>
                    </div>
                </div>
                <br>
                <div class="grid-3">
                    <div><label>Coffee (g)</label><input type="number" id="coffeeGrams" value="15" oninput="calcRatio()"></div>
                    <div><label>Water (g)</label><input type="number" id="waterGrams" value="255" oninput="calcRatio()"></div>
                    <div><label>Temp (°C)</label><input type="number" id="temp" value="94"></div>
                </div>
                <br>
                <div class="grid-2">
                    <div><label>Ratio 1 :</label><input type="text" id="ratioDisplay" readonly style="background:#eee; color:#666;"></div>
                    <div><label>Grind</label><input type="text" id="grindSize" placeholder="e.g. K-Max 6.2"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Add Step</div>
                <div class="grid-2">
                    <div>
                        <label>Type</label>
                        <select id="stepType">
                            <option value="Pour">Pour</option><option value="Bloom">Bloom</option>
                            <option value="Agitate">Agitate</option><option value="Wait">Wait</option>
                            <option value="Drawdown">Drawdown</option><option value="Prep">Prep</option>
                        </select>
                    </div>
                    <div><label>Label</label><input type="text" id="stepLabel" placeholder="Step Name"></div>
                </div>
                <br>
                <label>Color</label>
                <div class="color-picker" id="colorPicker">
                    <div class="color-dot bg-blue selected" data-color="bg-blue"></div>
                    <div class="color-dot bg-yellow" data-color="bg-yellow"></div>
                    <div class="color-dot bg-red" data-color="bg-red"></div>
                    <div class="color-dot bg-purple" data-color="bg-purple"></div>
                    <div class="color-dot bg-brown" data-color="bg-brown"></div>
                </div>
                <br>
                <div class="grid-2">
                    <div>
                        <label>Start (m:s)</label>
                        <div style="display:flex; gap:5px;"><input type="number" id="startMin" placeholder="0"><input type="number" id="startSec" placeholder="00"></div>
                    </div>
                    <div>
                        <label>End (m:s)</label>
                        <div style="display:flex; gap:5px;"><input type="number" id="endMin" placeholder="0"><input type="number" id="endSec" placeholder="00"></div>
                    </div>
                </div>
                <br>
                <label>Target Weight</label><input type="number" id="stepWeight" placeholder="Optional (g)">
                <br><br>
                <label>Notes</label><textarea id="stepNotes" rows="1" cols="50"></textarea>
                <button id="add-step-btn">Add Step</button>
            </div>
        </div>

        <div class="right-col">
            <div class="card" style="min-height: 500px;">
                <div class="card-header">Current Build</div>
                <div id="timeline-container" class="step-list">
                    <div style="text-align:center; color:#ccc; margin-top:50px;" id="empty-state">No steps added.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="library-container">
        <h2>Recipe Library</h2>
        <div id="library-grid" class="library-grid">
            <div style="color:#666;">Loading recipes...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, doc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "PASTE_YOUR_API_KEY_HERE", 
            authDomain: "coffee-database-92533.firebaseapp.com",
            projectId: "coffee-database-92533",
            storageBucket: "coffee-database-92533.firebasestorage.app",
            messagingSenderId: "788577377347",
            appId: "1:788577377347:web:3ed7f39df2bfb7828348f6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- BUILDER LOGIC ---
        let steps = [];
        let selectedColor = 'bg-blue';

        window.calcRatio = function() {
            const c = parseFloat(document.getElementById('coffeeGrams').value) || 0;
            const w = parseFloat(document.getElementById('waterGrams').value) || 0;
            const box = document.getElementById('ratioDisplay');
            box.value = (c > 0 && w > 0) ? (w / c).toFixed(1) : "-";
        }
        calcRatio();

        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.addEventListener('click', function() {
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
                this.classList.add('selected');
                selectedColor = this.getAttribute('data-color');
            });
        });

        document.getElementById('add-step-btn').addEventListener('click', function() {
            const sMin = document.getElementById('startMin').value || 0;
            const sSec = document.getElementById('startSec').value || 0;
            const eMin = document.getElementById('endMin').value || 0;
            const eSec = document.getElementById('endSec').value || 0;
            const timeStr = `${sMin}:${sSec.toString().padStart(2,'0')} → ${eMin}:${eSec.toString().padStart(2,'0')}`;

            const newStep = {
                id: Date.now(),
                type: document.getElementById('stepType').value,
                label: document.getElementById('stepLabel').value || document.getElementById('stepType').value,
                color: selectedColor,
                timeDisplay: timeStr,
                weight: document.getElementById('stepWeight').value ? ` · ${document.getElementById('stepWeight').value}g` : '',
                notes: document.getElementById('stepNotes').value
            };
            steps.push(newStep);
            renderBuilder();
        });

        function renderBuilder() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            steps.forEach((step, index) => {
                container.innerHTML += `
                    <div class="timeline-item">
                        <div class="color-bar ${step.color}"></div>
                        <div class="timeline-content">
                            <div class="step-header"><span class="step-title">${step.label}</span></div>
                            <div class="step-time">${step.timeDisplay} ${step.weight}</div>
                            <div class="step-details">${step.notes}</div>
                        </div>
                        <button class="delete-step" onclick="removeStep(${index})">×</button>
                    </div>`;
            });
        }
        window.removeStep = (idx) => { steps.splice(idx, 1); renderBuilder(); };

        // --- SAVE LOGIC ---
        document.getElementById('save-recipe-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-recipe-btn');
            btn.textContent = "Saving...";
            
            const recipeData = {
                name: document.getElementById('recipeName').value || "Untitled",
                bean: document.getElementById('beanName').value || "",
                brewer: document.getElementById('brewer').value,
                coffee: Number(document.getElementById('coffeeGrams').value),
                water: Number(document.getElementById('waterGrams').value),
                temp: Number(document.getElementById('temp').value),
                grind: document.getElementById('grindSize').value,
                steps: steps,
                timestamp: serverTimestamp()
            };
            try {
                await addDoc(collection(db, "recipes"), recipeData);
                btn.textContent = "Saved!";
                setTimeout(() => btn.textContent = "Save Recipe", 2000);
                
                // ➕ ADD THESE LINES TO CLEAR THE FORM:
                document.getElementById('recipeName').value = "";
                document.getElementById('beanName').value = "";
                document.getElementById('brewer').value = ""; // Clears the Method
                document.getElementById('stepNotes').value = "";
                
                // ➕ Reset Steps for the next recipe
                steps = []; 
                renderBuilder(); 

            } catch(e) {
                alert("Save Error: " + e.message);
                btn.textContent = "Save Recipe";
            }
        });

        // --- LIBRARY LOGIC (VIEWER) ---
        const q = query(collection(db, "recipes"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = "";
            snapshot.forEach(doc => {
                const r = doc.data();
                const ratio = (r.water / r.coffee).toFixed(1);
                
                // Build Steps HTML for the card
                let stepsHtml = "";
                if(r.steps && Array.isArray(r.steps)) {
                    r.steps.forEach(s => {
                        stepsHtml += `
                            <div class="timeline-item" style="margin-bottom:5px; padding:0;">
                                <div class="color-bar ${s.color}" style="width:5px;"></div>
                                <div class="timeline-content" style="padding:8px;">
                                    <div style="font-weight:bold; font-size:0.8rem;">${s.label}</div>
                                    <div style="font-size:0.75rem; font-family:monospace;">${s.timeDisplay}</div>
                                </div>
                            </div>
                        `;
                    });
                }

                const card = document.createElement('div');
                card.className = "saved-recipe-card";
                card.innerHTML = `
                    <div class="saved-header">
                        <h3>${r.name}</h3>
                        <div class="saved-meta">${r.bean}</div>
                        <button class="delete-recipe-btn" onclick="deleteRecipe('${doc.id}')">×</button>
                    </div>
                    <div class="saved-tags">
                        <span class="tag">${r.brewer}</span>
                        <span class="tag">1:${ratio}</span>
                        <span class="tag">${r.coffee}g In</span>
                    </div>
                    <div style="max-height:200px; overflow-y:auto; border-top:1px solid #eee; padding-top:10px;">
                        ${stepsHtml || "<small>No steps recorded</small>"}
                    </div>
                `;
                grid.appendChild(card);
            });
        });

        window.deleteRecipe = async (id) => {
            if(confirm("Delete this recipe permanently?")) {
                await deleteDoc(doc(db, "recipes", id));
            }
        };

    </script>
</body>
</html>
