<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Bean Stack</title>
    <style>
        :root {
            --bg: #F9F9F9;
            --surface: #FFFFFF; 
            --text: #333;
            --border: #E0E0E0;
            --primary: #333;
            --accent-blue: #A2D2FF;
            --accent-red: #FFAAA5;
            --accent-yellow: #FFD3B6;
            --accent-purple: #E0C3FC;
            --accent-brown: #D7CCC8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- LAYOUT --- */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        @media (max-width: 768px) {
            .main-container { grid-template-columns: 1fr; } 
        }

        h1, h2 { display: flex; align-items: center; gap: 10px; margin: 0 0 20px 0; }
        h2 { font-size: 1.3rem; margin-top: 40px; margin-bottom: 15px; border-top: 1px solid #ddd; padding-top: 20px; }
        .logo-icon { font-size: 1.5rem; }

        /* --- CARDS --- */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: border-color 0.2s;
        }
        
        .step-edit-active {
            border: 2px solid #333 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .card-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- FORMS --- */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        label { display: block; font-size: 0.75rem; font-weight: 600; color: #666; margin-bottom: 5px; }
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.9rem; background: #FAFAFA; box-sizing: border-box;
        }
        
        /* --- BUTTONS --- */
        button { cursor: pointer; border: none; font-weight: bold; border-radius: 6px; }
        
        #add-step-btn { width: 100%; background: #333; color: white; padding: 12px; margin-top: 15px; transition: background 0.2s; }
        #add-step-btn.updating { background: #4CAF50; } 
        
        #cancel-step-edit { 
            background: none; color: #888; text-decoration: underline; font-size: 0.8rem; 
            cursor: pointer; display: none; 
        }

        #save-recipe-btn { background: #FF4444; color: white; padding: 10px 20px; border-radius: 20px; float: right; }
        #cancel-edit-btn { background: #999; color: white; padding: 10px 20px; border-radius: 20px; float: right; margin-right: 10px; display: none; }
        
        /* --- TIMELINE --- */
        .step-list { display: flex; flex-direction: column; gap: 10px; }
        .timeline-item {
            display: flex; background: white; border: 1px solid var(--border);
            border-radius: 8px; overflow: hidden; position: relative;
        }
        .color-bar { width: 12px; flex-shrink: 0; }
        .timeline-content { padding: 12px 15px; flex-grow: 1; }
        .step-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .step-title { font-weight: 700; font-size: 0.95rem; }
        .step-time { font-family: monospace; font-size: 1.1rem; font-weight: 600; color: #333; }
        .step-details { font-size: 0.85rem; color: #555; margin-top: 4px; }
        
        .action-btn { background: none; border: none; font-size: 1.1rem; padding: 0 10px; cursor: pointer; color: #ccc; }
        .edit-btn:hover { color: #333; }
        .delete-btn:hover { color: #FF4444; }
        .actions { display: flex; align-items: center; padding-right: 5px; }

        /* --- LIBRARY --- */
        .search-container { margin-bottom: 20px; }
        #searchInput {
            width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem;
            background: white no-repeat 96% center;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23999" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>');
        }

        .library-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }
        .saved-recipe-card {
            background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px;
            transition: transform 0.2s; position: relative; cursor: pointer;
        }
        .saved-recipe-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: #333; }
        .saved-header h3 { margin: 0; font-size: 1.1rem; color: var(--primary); }
        .saved-meta { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .saved-tags { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; background: #eee; font-weight: 600; }
        .card-rating { color: #FFD700; font-size: 0.9rem; float: right; }
        
        .delete-recipe-btn { 
            position: absolute; top: 15px; right: 15px; background: none; 
            color: #ff4444; font-size: 1.2rem; padding: 0; z-index: 10;
        }

        /* --- STAR RATING --- */
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; gap: 5px; }
        .star-rating input { display: none; }
        .star-rating label { cursor: pointer; font-size: 1.5rem; color: #ddd; margin: 0; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #FFD700; }

        /* Helpers */
        .bg-yellow { background-color: #FCDF87; } .bg-blue { background-color: #B2DFDB; }
        .bg-red { background-color: #FFCDD2; } .bg-purple { background-color: #E1BEE7; }
        .bg-gray { background-color: #EEEEEE; } .bg-brown { background-color: #D7CCC8; }
        .selected { transform: scale(1.1); border: 2px solid #333; }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-picker { display: flex; gap: 10px; margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <h1>
            <span class="logo-icon">‚òï</span> The Daily Brew
            <div style="margin-left:auto; display:flex; gap:10px;">
                <button id="cancel-edit-btn">Cancel</button>
                <button id="save-recipe-btn">Save Recipe</button>
            </div>
        </h1>
    </header>

    <div class="main-container">
        
        <div class="left-col">
            
            <div class="card" id="details-card">
                <div class="card-header">Details</div>
                <div style="margin-bottom: 15px;">
                    <label>Bean Name</label>
                    <input type="text" id="beanName" placeholder="e.g. Ethiopia Yirgacheffe" autocomplete="off">
                </div>
                <div class="grid-2">
                    <div>
                        <label>Recipe Name</label>
                        <input type="text" id="recipeName" placeholder="Morning V60">
                    </div>
                    <div>
                        <label>Method</label>
                        <input type="text" id="brewer" list="methodSuggestions" placeholder="Select" autocomplete="off">
                        <datalist id="methodSuggestions">
                            <option value="V60"></option>
                            <option value="Aeropress"></option>
                            <option value="Inverted Aeropress"></option>
                            <option value="French Press"></option>
                            <option value="Moka Pot"></option>
                            <option value="Chemex"></option>
                            <option value="Cold Brew"></option>
                            <option value="Siphon"></option>
                        </datalist>
                    </div>
                </div>
                <br>
                <div class="grid-3">
                    <div><label>Coffee (g)</label><input type="number" id="coffeeGrams" value="15" oninput="calcRatio()"></div>
                    <div><label>Water (g)</label><input type="number" id="waterGrams" value="240" oninput="calcRatio()"></div>
                    <div><label>Temp (¬∞C)</label><input type="number" id="temp" placeholder="92"></div>
                </div>
                <br>
                <div class="grid-2">
                    <div><label>Ratio 1 :</label><input type="text" id="ratioDisplay" readonly style="background:#eee; color:#666;"></div>
                    <div><label>Grind</label><input type="text" id="grindSize" placeholder="18 Clicks"></div>
                </div>
            </div>

            <div class="card" id="step-form-card">
                <div class="card-header">
                    <span id="step-card-title">Add Step</span>
                    <button id="cancel-step-edit">Cancel Edit</button>
                </div>
                
                <div class="grid-2">
                    <div>
                        <label>Type</label>
                        <select id="stepType">
                            <option value="Pour">Pour</option><option value="Bloom">Bloom</option>
                            <option value="Steep">Steep</option>
                            <option value="Agitate">Agitate</option><option value="Wait">Wait</option>
                            <option value="Drawdown">Drawdown</option><option value="Prep">Prep</option>
                        </select>
                    </div>
                    <div><label>Label</label><input type="text" id="stepLabel" placeholder="Step Name"></div>
                </div>
                <br>
                <label>Color</label>
                <div class="color-picker" id="colorPicker">
                    <div class="color-dot bg-blue selected" data-color="bg-blue"></div>
                    <div class="color-dot bg-yellow" data-color="bg-yellow"></div>
                    <div class="color-dot bg-red" data-color="bg-red"></div>
                    <div class="color-dot bg-purple" data-color="bg-purple"></div>
                    <div class="color-dot bg-brown" data-color="bg-brown"></div>
                </div>
                <br>
                <div class="grid-2">
                    <div>
                        <label>Start (m:s)</label>
                        <div style="display:flex; gap:5px;"><input type="number" id="startMin" placeholder="0"><input type="number" id="startSec" placeholder="00"></div>
                    </div>
                    <div>
                        <label>End (m:s)</label>
                        <div style="display:flex; gap:5px;"><input type="number" id="endMin" placeholder="0"><input type="number" id="endSec" placeholder="00"></div>
                    </div>
                </div>
                <br>
                <label>Target Weight</label><input type="number" id="stepWeight" placeholder="Optional (g)">
                <br><br>
                
                <div class="grid-2" style="align-items: center; margin-bottom: 15px;">
                    <label style="margin:0;">Rate this Brew</label>
                    <div class="star-rating">
                        <input type="radio" id="star5" name="rating" value="5"><label for="star5">‚òÖ</label>
                        <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÖ</label>
                        <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÖ</label>
                        <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÖ</label>
                        <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÖ</label>
                    </div>
                </div>

                <label>Notes</label><textarea id="stepNotes" rows="2"></textarea>
                <button id="add-step-btn">Add Step</button>
            </div>

            <!-- Coffee Beans Tracker -->
            <div class="card" id="beans-tracker-card">
                <div class="card-header">‚òï Coffee Beans I've Tried</div>
                <div style="margin-bottom: 15px;">
                    <label>Bean Name</label>
                    <input type="text" id="trackedBeanName" placeholder="e.g. Ethiopia Yirgacheffe" autocomplete="off">
                </div>
                <div class="grid-2">
                    <div>
                        <label>Origin</label>
                        <input type="text" id="trackedOrigin" placeholder="e.g. Ethiopia" autocomplete="off">
                    </div>
                    <div>
                        <label>Roaster</label>
                        <input type="text" id="trackedRoaster" placeholder="e.g. Blue Bottle" autocomplete="off">
                    </div>
                </div>
            
                <div class="grid-2" style="align-items: center; margin-top: 15px;">
                    <label style="margin:0;">Rating</label>
                    <div class="star-rating">
                        <input type="radio" id="bean-star5" name="bean-rating" value="5">
                        <label for="bean-star5">‚òÖ</label>
                        <input type="radio" id="bean-star4" name="bean-rating" value="4">
                        <label for="bean-star4">‚òÖ</label>
                        <input type="radio" id="bean-star3" name="bean-rating" value="3">
                        <label for="bean-star3">‚òÖ</label>
                        <input type="radio" id="bean-star2" name="bean-rating" value="2">
                        <label for="bean-star2">‚òÖ</label>
                        <input type="radio" id="bean-star1" name="bean-rating" value="1">
                        <label for="bean-star1">‚òÖ</label>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <label>Notes</label>
                    <textarea id="trackedNotes" rows="2" placeholder="Your thoughts on this bean..."></textarea>
                </div>
                <button id="add-bean-btn" style="width: 100%; background: #333; color: white; padding: 12px; margin-top: 15px;">Add Bean</button>
                <button id="cancel-bean-edit" style="background: none; color: #888; text-decoration: underline; font-size: 0.8rem; cursor: pointer; display: none; width: 100%; margin-top: 5px;">Cancel</button>
            </div>
        </div>

        <div class="right-col">
            <div class="card" style="min-height: 500px;">
                <div class="card-header">Timeline</div>
                <div id="timeline-container" class="step-list">
                    <div style="text-align:center; color:#ccc; margin-top:50px;" id="empty-state">No steps added.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="library-container">
        <h2>üìö Coffee Log <small style="font-size:0.8rem; color:#888; font-weight:normal;">`</small></h2>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search beans, methods, or notes...">
        </div>
        <div id="library-grid" class="library-grid">
            <div style="color:#666;">Loading recipes...</div>
        </div>
    </div>

    <div class="library-container">
        <h2>‚òï My Beans Collection</h2>
        <div class="search-container">
            <input type="text" id="searchBeansInput" placeholder="Search beans by name, origin, or roaster...">
        </div>
        <div id="beans-library-grid" class="library-grid">
            <div style="color:#666;">Loading beans...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, doc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è PASTE YOUR API KEY BELOW ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è
            const firebaseConfig = {
            apiKey: "PASTE_YOUR_API_KEY_HERE", 
            authDomain: "coffee-database-92533.firebaseapp.com",
            projectId: "coffee-database-92533",
            storageBucket: "coffee-database-92533.firebasestorage.app",
            messagingSenderId: "788577377347",
            appId: "1:788577377347:web:3ed7f39df2bfb7828348f6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let steps = [];
        let allRecipes = [];
        let allBeans = [];
        let selectedColor = 'bg-blue';
        let editingId = null;        
        let editingStepIndex = null;
        let editingBeanId = null; 

        // 1. RATIO CALC
        window.calcRatio = function() {
            const c = parseFloat(document.getElementById('coffeeGrams').value) || 0;
            const w = parseFloat(document.getElementById('waterGrams').value) || 0;
            document.getElementById('ratioDisplay').value = (c > 0 && w > 0) ? (w / c).toFixed(1) : "-";
        }
        calcRatio();

        // 2. COLOR PICKER
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.addEventListener('click', function() {
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
                this.classList.add('selected');
                selectedColor = this.getAttribute('data-color');
            });
        });

        // 3. ADD / UPDATE STEP LOGIC
        document.getElementById('add-step-btn').addEventListener('click', function() {
            const sMin = document.getElementById('startMin').value || 0;
            const sSec = document.getElementById('startSec').value || 0;
            const eMin = document.getElementById('endMin').value || 0;
            const eSec = document.getElementById('endSec').value || 0;
            const timeStr = `${sMin}:${sSec.toString().padStart(2,'0')} ‚Üí ${eMin}:${eSec.toString().padStart(2,'0')}`;

            const stepData = {
                id: Date.now(),
                type: document.getElementById('stepType').value,
                label: document.getElementById('stepLabel').value || document.getElementById('stepType').value,
                color: selectedColor,
                startMin: sMin, startSec: sSec, endMin: eMin, endSec: eSec,
                timeDisplay: timeStr,
                weight: document.getElementById('stepWeight').value ? ` ¬∑ ${document.getElementById('stepWeight').value}g` : '',
                weightRaw: document.getElementById('stepWeight').value, 
                notes: document.getElementById('stepNotes').value
            };

            if (editingStepIndex !== null) {
                // UPDATE EXISTING STEP (In Place)
                steps[editingStepIndex] = stepData;
                editingStepIndex = null; 
                resetStepForm(false); 
            } else {
                // ADD NEW STEP
                steps.push(stepData);
                // Auto-chain: Next step starts where this one ended
                resetStepForm(true, eMin, eSec);
            }

            renderBuilder();
        });

        function resetStepForm(chain = false, min = "", sec = "") {
            document.getElementById('stepLabel').value = "";
            document.getElementById('stepWeight').value = "";
            document.getElementById('stepNotes').value = "";
            
            if (chain) {
                document.getElementById('startMin').value = min;
                document.getElementById('startSec').value = sec;
            } else {
                document.getElementById('startMin').value = "";
                document.getElementById('startSec').value = "";
            }
            
            document.getElementById('endMin').value = "";
            document.getElementById('endSec').value = "";
            
            document.getElementById('add-step-btn').textContent = "Add Step";
            document.getElementById('add-step-btn').classList.remove('updating');
            document.getElementById('step-card-title').textContent = "Add Step";
            document.getElementById('cancel-step-edit').style.display = 'none';
            document.getElementById('step-form-card').classList.remove('step-edit-active');
            editingStepIndex = null;
        }

        document.getElementById('cancel-step-edit').addEventListener('click', function() {
            resetStepForm(false);
        });

        // 4. RENDER BUILDER (With Edit Buttons)
        function renderBuilder() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            if(steps.length === 0) container.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:50px;">No steps added.</div>';
            
            steps.forEach((step, index) => {
                const el = document.createElement('div');
                el.className = 'timeline-item';
                el.innerHTML = `
                    <div class="color-bar ${step.color}"></div>
                    <div class="timeline-content">
                        <div class="step-header"><span class="step-title">${step.label}</span></div>
                        <div class="step-time">${step.timeDisplay} ${step.weight}</div>
                        <div class="step-details">${step.notes}</div>
                    </div>
                    <div class="actions">
                        <button class="action-btn edit-btn" onclick="editStep(${index})">‚úèÔ∏è</button>
                        <button class="action-btn delete-btn" onclick="removeStep(${index})">√ó</button>
                    </div>`;
                container.appendChild(el);
            });
        }

        // 5. EDIT STEP FUNCTION
        window.editStep = function(index) {
            const step = steps[index];
            editingStepIndex = index; 

            document.getElementById('stepType').value = step.type;
            document.getElementById('stepLabel').value = step.label;
            document.getElementById('stepWeight').value = step.weightRaw || "";
            document.getElementById('stepNotes').value = step.notes;
            
            document.getElementById('startMin').value = step.startMin || 0;
            document.getElementById('startSec').value = step.startSec || 0;
            document.getElementById('endMin').value = step.endMin || 0;
            document.getElementById('endSec').value = step.endSec || 0;

            selectedColor = step.color;
            document.querySelectorAll('.color-dot').forEach(d => {
                d.classList.remove('selected');
                if(d.getAttribute('data-color') === step.color) d.classList.add('selected');
            });

            document.getElementById('add-step-btn').textContent = "Update Step";
            document.getElementById('add-step-btn').classList.add('updating');
            document.getElementById('step-card-title').textContent = "Editing Step " + (index + 1);
            document.getElementById('cancel-step-edit').style.display = 'inline-block';
            document.getElementById('step-form-card').classList.add('step-edit-active');

            document.getElementById('step-form-card').scrollIntoView({ behavior: 'smooth' });
        };

        window.removeStep = (idx) => { 
            if(editingStepIndex === idx) resetStepForm(false); 
            steps.splice(idx, 1); 
            renderBuilder(); 
        };

        // 5B. BEANS TRACKER
        document.getElementById('add-bean-btn').addEventListener('click', async () => {
            const btn = document.getElementById('add-bean-btn');
            const originalText = btn.textContent;
            
            const beanName = document.getElementById('trackedBeanName').value.trim();
            if (!beanName) {
                alert('Please enter a bean name');
                return;
            }

            btn.textContent = editingBeanId ? "Updating..." : "Saving...";
            
            const ratingEl = document.querySelector('input[name="bean-rating"]:checked');
            const ratingVal = ratingEl ? Number(ratingEl.value) : 0;

            const beanData = {
                name: beanName,
                origin: document.getElementById('trackedOrigin').value.trim() || "",
                roaster: document.getElementById('trackedRoaster').value.trim() || "",
                notes: document.getElementById('trackedNotes').value.trim() || "",
                rating: ratingVal,
                timestamp: serverTimestamp()
            };

            try {
                if (editingBeanId) {
                    await setDoc(doc(db, "beans", editingBeanId), beanData);
                } else {
                    await addDoc(collection(db, "beans"), beanData);
                }
                resetBeanForm();
                btn.textContent = originalText;
            } catch(e) {
                alert("Save Error: " + e.message);
                btn.textContent = originalText;
            }
        });

        document.getElementById('cancel-bean-edit').addEventListener('click', resetBeanForm);

        function resetBeanForm() {
            editingBeanId = null;
            document.getElementById('trackedBeanName').value = "";
            document.getElementById('trackedOrigin').value = "";
            document.getElementById('trackedRoaster').value = "";
            document.getElementById('trackedNotes').value = "";
            
            const ratingEl = document.querySelector('input[name="bean-rating"]:checked');
            if(ratingEl) ratingEl.checked = false;
            
            document.getElementById('add-bean-btn').textContent = "Add Bean";
            document.getElementById('cancel-bean-edit').style.display = 'none';
            document.getElementById('beans-tracker-card').classList.remove('step-edit-active');
        }

        window.editBean = function(id) {
            const bean = allBeans.find(b => b.id === id);
            if (!bean) return;

            document.getElementById('trackedBeanName').value = bean.name || "";
            document.getElementById('trackedOrigin').value = bean.origin || "";
            document.getElementById('trackedRoaster').value = bean.roaster || "";
            document.getElementById('trackedNotes').value = bean.notes || "";

            const stars = document.querySelectorAll('input[name="bean-rating"]');
            stars.forEach(s => s.checked = false);
            if(bean.rating) {
                const radio = document.querySelector(`input[name="bean-rating"][value="${bean.rating}"]`);
                if(radio) radio.checked = true;
            }

            editingBeanId = id;
            document.getElementById('add-bean-btn').textContent = "Update Bean";
            document.getElementById('cancel-bean-edit').style.display = 'inline-block';
            document.getElementById('beans-tracker-card').classList.add('step-edit-active');
            document.getElementById('beans-tracker-card').scrollIntoView({ behavior: 'smooth' });
        };

        window.deleteBean = async (id) => {
            if(confirm("Delete this bean from your collection?")) {
                await deleteDoc(doc(db, "beans", id));
                if(editingBeanId === id) resetBeanForm();
            }
        };

        // BEANS LIBRARY RENDERING
        const beansQuery = query(collection(db, "beans"), orderBy("timestamp", "desc"));

        onSnapshot(beansQuery, (snapshot) => {
            allBeans = []; 
            snapshot.forEach(doc => {
                allBeans.push({ id: doc.id, ...doc.data() });
            });
            renderBeansLibrary(allBeans);
        });

        function renderBeansLibrary(beansToRender) {
            const grid = document.getElementById('beans-library-grid');
            grid.innerHTML = "";
            
            if(beansToRender.length === 0) {
                grid.innerHTML = "<div style='color:#ccc; text-align:center;'>No beans tracked yet. Add your first coffee bean above!</div>";
                return;
            }

            beansToRender.forEach(bean => {
                const stars = "‚òÖ".repeat(bean.rating || 0) + "‚òÜ".repeat(5 - (bean.rating || 0));
                
                const card = document.createElement('div');
                card.className = "saved-recipe-card";
                card.onclick = (e) => {
                    if(!e.target.classList.contains('delete-recipe-btn')) editBean(bean.id);
                };

                const roasterTag = bean.roaster ? `<span class="tag">${bean.roaster}</span>` : '';
                const originTag = bean.origin ? `<span class="tag">${bean.origin}</span>` : '';

                card.innerHTML = `
                    <div class="saved-header">
                        <div style="display:flex; justify-content:space-between;">
                            <h3>${bean.name}</h3>
                            <span class="card-rating">${stars}</span>
                        </div>
                        ${bean.origin || bean.roaster ? '<div class="saved-meta">' + (bean.origin || '') + (bean.origin && bean.roaster ? ' ‚Ä¢ ' : '') + (bean.roaster || '') + '</div>' : ''}
                        <button class="delete-recipe-btn" onclick="deleteBean('${bean.id}')">√ó</button>
                    </div>
                    ${bean.origin || bean.roaster ? '<div class="saved-tags">' + originTag + roasterTag + '</div>' : ''}
                    ${bean.notes ? '<div style="font-size:0.85rem; color:#666; margin-top:10px; font-style:italic;">"' + bean.notes + '"</div>' : ''}
                `;
                grid.appendChild(card);
            });
        }

        // Beans Search Filter
        document.getElementById('searchBeansInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allBeans.filter(b => 
                (b.name && b.name.toLowerCase().includes(term)) ||
                (b.origin && b.origin.toLowerCase().includes(term)) ||
                (b.roaster && b.roaster.toLowerCase().includes(term)) ||
                (b.notes && b.notes.toLowerCase().includes(term))
            );
            renderBeansLibrary(filtered);
        });

        // 6. SAVE RECIPE
        document.getElementById('save-recipe-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-recipe-btn');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            const ratingVal = ratingEl ? Number(ratingEl.value) : 0;

            const recipeData = {
                name: document.getElementById('recipeName').value || "Untitled",
                bean: document.getElementById('beanName').value || "",
                brewer: document.getElementById('brewer').value,
                coffee: Number(document.getElementById('coffeeGrams').value),
                water: Number(document.getElementById('waterGrams').value),
                temp: Number(document.getElementById('temp').value),
                grind: document.getElementById('grindSize').value,
                rating: ratingVal,
                steps: steps,
                timestamp: serverTimestamp()
            };

            try {
                if (editingId) {
                    await setDoc(doc(db, "recipes", editingId), recipeData);
                    alert("Recipe Updated! ‚ú®");
                } else {
                    await addDoc(collection(db, "recipes"), recipeData);
                }
                resetFullForm();
                btn.textContent = originalText;
            } catch(e) {
                alert("Save Error: " + e.message);
                btn.textContent = originalText;
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', resetFullForm);

        function resetFullForm() {
            editingId = null;
            resetStepForm(false); 
            document.getElementById('recipeName').value = "";
            document.getElementById('beanName').value = "";
            document.getElementById('brewer').value = "";
            
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            if(ratingEl) ratingEl.checked = false;

            steps = []; 
            renderBuilder();
            
            document.getElementById('save-recipe-btn').textContent = "Save Recipe";
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('details-card').classList.remove('edit-mode-active');
            window.scrollTo(0,0);
        }

        // 7. LIBRARY & LOAD
        const q = query(collection(db, "recipes"), orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            allRecipes = []; 
            snapshot.forEach(doc => {
                allRecipes.push({ id: doc.id, ...doc.data() });
            });
            renderLibrary(allRecipes);
        });

        window.loadForEdit = function(id) {
            const r = allRecipes.find(x => x.id === id);
            if(!r) return;

            document.getElementById('beanName').value = r.bean || "";
            document.getElementById('recipeName').value = r.name || "";
            document.getElementById('brewer').value = r.brewer || "";
            document.getElementById('coffeeGrams').value = r.coffee || 0;
            document.getElementById('waterGrams').value = r.water || 0;
            document.getElementById('temp').value = r.temp || 93;
            document.getElementById('grindSize').value = r.grind || "";
            calcRatio();

            const stars = document.querySelectorAll('input[name="rating"]');
            stars.forEach(s => s.checked = false);
            if(r.rating) {
                const radio = document.querySelector(`input[name="rating"][value="${r.rating}"]`);
                if(radio) radio.checked = true;
            }

            steps = r.steps || [];
            renderBuilder();

            editingId = id;
            document.getElementById('save-recipe-btn').textContent = "Update Recipe";
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            document.getElementById('details-card').classList.add('edit-mode-active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function renderLibrary(recipesToRender) {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = "";
            
            if(recipesToRender.length === 0) {
                grid.innerHTML = "<div style='color:#ccc; text-align:center;'>No coffees found.</div>";
                return;
            }

            recipesToRender.forEach(r => {
                const ratio = (r.water / r.coffee).toFixed(1);
                const stars = "‚òÖ".repeat(r.rating || 0) + "‚òÜ".repeat(5 - (r.rating || 0));
                const stepCount = r.steps ? r.steps.length : 0;
                
                const card = document.createElement('div');
                card.className = "saved-recipe-card";
                card.onclick = (e) => {
                    if(!e.target.classList.contains('delete-recipe-btn')) loadForEdit(r.id);
                };

                card.innerHTML = `
                    <div class="saved-header">
                        <div style="display:flex; justify-content:space-between;">
                            <h3>${r.name}</h3>
                            <span class="card-rating">${stars}</span>
                        </div>
                        <div class="saved-meta">${r.bean || "Unknown Bean"}</div>
                        <button class="delete-recipe-btn" onclick="deleteRecipe('${r.id}')">√ó</button>
                    </div>
                    <div class="saved-tags">
                        <span class="tag">${r.brewer}</span>
                        <span class="tag">1:${ratio}</span>
                        <span class="tag">${stepCount} Steps</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Search Filter
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allRecipes.filter(r => 
                (r.name && r.name.toLowerCase().includes(term)) ||
                (r.bean && r.bean.toLowerCase().includes(term)) ||
                (r.brewer && r.brewer.toLowerCase().includes(term))
            );
            renderLibrary(filtered);
        });

        // 8. DELETE RECIPE
        window.deleteRecipe = async (id) => {
            if(confirm("Delete this recipe permanently?")) {
                await deleteDoc(doc(db, "recipes", id));
                if(editingId === id) resetFullForm();
            }
        };

    </script>
</body>
</html>